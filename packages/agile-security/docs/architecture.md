# Architecture

AGILE IDM is comprised of several modules (some of them are available as stand alone node packages).

<table align="center">
	<tr>
		<td><img src="images/idm-architecture.jpg" /></td>
	</tr>
	<tr align="center">
		<td>
			Agile IDM architecture
		</td>
	</tr>
</table>

In the AGILE IDM architecture, the following visual conventions were adopted:
* components drawn with a dashed line:  available as a separate node js modules.
* components with gray background: modules that interact with an AGILE Oauth2 client or with the user through a web browser.
* Arrows: denote data flows in the direction of the arrow.

## Modules' Responsibilities 

For the description of basic responsibilities of each sub-module please refer to:

* **agile-entity-storage**: provide an interface to a lightweight database to store entities and groups, while ensuring isolation and serialization of transactions. For more info check https://github.com/Agile-IoT/agile-idm-entity-storage
* **token storage**: store access tokens received from external providers and generated by IDM.
* **agile-idm-core**: provide an API to store and read entities, attributes, groups while ensuring proper policy enforcement to write and read for entity's attributes and preservation of entity formats. agile-idm-core requires agile-idm-entity-storage to handle the persistence of entities. For more info check https://github.com/Agile-IoT/agile-idm-core
* **Oauth2Server**: component taking care of OAuth2 server-side logic. In other words, this component allows applications to be oauth2 clients and rely on AGILE IDM to behave as an identity provider for them.
 * **oauth2-orize module**: this module generates access codes and exchanges them for tokens after the oauth2 client has been authenticated and has provided a proper authorization code. Also, the oauth2-orize module requires direct access to the agile-idm-entity storage because it needs to find clients by id and verify their secret before exchanging an authorization code for an access token.
 * **authentication providers**: this module loads a set of authentication providers that interact with users to authenticate them with different passport strategies. This component uses the token storage to save tokens obtained or generated by authentication providers. Also authentication providers use agile-idm-entity-storage to ensure that only users that are stored as entities of type user in the AGILE IDM database can log in. For more information check  https://github.com/Agile-IoT/agile-idm-web-ui/blob/master/docs/authentication.md
* **REST Entity API**: this module is an express router encapsulating the entity management api. It requires an access token when it is called through HTTP and it relies on agile-idm-core to enforce proper policies to read and write attributes. It requires access to the token storage to verify the owner of a token provided during the REST call.
* **Oauth2 server API**: this is an express router taking care of exposing the proper HTTP calls to make AGILE IDM an Oauth2 provider.


